# ESP32 Servo Motion Kit 仕様書（ドラフト）

## 目的とスコープ
- ESP32 向け Arduino（v3.0+）ライブラリで、ホビー用 PWM サーボと TTL/バスサーボを同期制御できるチェーン可能な API を提供する。
- ブラウザ UI から WebSerial で設定・動作を編集し、ESP32 に送信して即座に試せる体験を実現する。
- WebSerial プロトコルで受信した設定を適用し、ライブラリ経由でサーボを駆動する ESP32 ファームウェアを提供する。
- 範囲外: 電気設計/PCB/BOM、サーボ本体のファーム改変、クラウド連携。

## 利用方針
- 内部構造ではなく「ユーザーがどう動かすか」から設計を積み上げる。
- Arduino API は流れるように書けるチェーンスタイルで、ジョイント/ポーズ/モーション定義を簡潔に。
- デフォルトは高レベルで安全; 詳細調整は必要なときにだけ開く。
- UI 主導で設定 → WebSerial 送信 → 即試行までを一貫させ、設定変更に再フラッシュを要求しない。

## 想定ユーザーとゴール
- マイコン/ロボットを素早く動かしたいメイカー・ホビイスト。
- 授業やデモで再現性のあるポーズ/モーションを作りたい教育者・展示担当。
- ゴール: 迅速なセットアップ、最小限の手順での操作、ブラウザからの即時試行、複数軸の同期動作。

## UX とフロー（ユースケース別）
- **ライブラリ単体利用（コード中心）**
  - Arduino スケッチ内でジョイント/ポーズ/モーション/シーケンスを定義し、`setup()` で初期化、`loop()` で play/stop/query を呼ぶ。
  - PC/スマホ UI は使わず、シリアルモニタ等でログ確認や微調整。設定変更はスケッチ再ビルドで適用。
- **UI でモーション作成 → 専用ファームで検証 → ライブラリ用ヘッダ出力**
  - ブラウザ UI でジョイント → ポーズ → モーション/シーケンスを編集・プレビュー。ジョイントグループは送信前に展開し、無効軸は除外。
  - ESP32 に専用ファームウェア（UI 連携用）を書き込み、WebSerial でデバイス JSON を送信して動作確認・保存。再生中の状態/ログ取得、緊急停止が可能。
  - 確認後、UI からライブラリ向けヘッダ（単一 .h）を出力。初期化コードとモーション/ポーズ定義を含み、ユーザーはスケッチ側で取り込み、`play` などの API を呼べば再生できる。

## コア概念
- **サーボ**: PWM（180/360 度）や TTL/バス（マルチドロップ/ハーフデュプレックスなど）を含むサーボチャネルを管理。GPIO/バス割り当て、オフセット/ニュートラル、位置・速度・トルク上限（対応する場合）、キャリブレーションを設定可能。プロトコル差分はライブラリで吸収。
- **ジョイント**: 論理軸。1 つ以上のサーボチャネルにマッピングでき、ゲイン/オフセットでミラー動作や負荷分担（同一軸にサーボを複数重ねてトルクを共有）を表現。
- **ジョイントグループ**: UI 専用の論理集合。複数ジョイントをまとめて選択/操作するラベルで、ESP32 側には実体を持たない。UI でグループを指定したポーズは送信前に各ジョイントへ展開される。
- **ポーズ**: ジョイント目標をまとめた名前付きセット（角度/位置、速度・トルクヒントを含む場合あり）。軸ごとに有効/無効フラグを持ち、無効な軸はグループ展開時に除外され、ESP32 への対象軸にも含まれない。
- **モーション**: ポーズ間の遷移。時間（duration）とプロファイル（イージングカーブ）を持つ。
- **シーケンス**: モーション/ポーズの順序リスト。ループやトリガーを持つ再生単位。
- **プロファイル（イージング）**: 時間に対する位置/速度カーブの定義。リニア、イージイン/アウト、独自カーブなどをモーションに適用する。

## コンポーネントと役割
- **Arduino ライブラリ (ESP32, v3.0+)**
  - PWM ピンと TTL バスラインの設定/接続をサポートし、混在利用を可能にする。
  - ジョイントビルダー: 軸定義、サーボ割り当て、リミット、ニュートラル/オフセット、キャリブレーション。
  - ポーズ/モーションビルダー: ポーズ作成、遷移・シーケンス定義、同期再生。
  - ランタイム: 同期更新スケジューラ、安全リミット、ソフトスタート/ストップ。
  - API はスケッチ的な流れで書けることを最優先する。
- **ESP32 ファームウェア (WebSerial ブリッジ)**
  - WebSerial セッション管理、JSON コマンド/設定の受信、ログ/状態の返却。
  - デバイス向け軽量 JSON をフラッシュ/FS に保存し、起動時にデフォルトをロード可能。
  - 再生/停止コマンドを実行し、進行状況やエラーを報告。
- **ブラウザ UI**
  - ジョイント/ポーズ/モーションをタイムラインで編集できるリッチエディタ。
  - WebSerial で接続/切断、ポート一覧、前回デバイスの再接続。
  - 設定検証、モーションカーブのプレビュー、送信前のタイミング確認。
  - 設定送信と実行トリガー、ログ/テレメトリの取得表示。

## データモデルと設定

### メタ
UI/デバイス共通のスキーマ識別子とバージョン管理に使う。
```json
{
  "meta": {
    "schema": "motionkit",
    "version": "0.1.0"
  }
}
```
#### リッチUI JSON
```json
{
  "meta": {
    "schema": "motionkit",
    "version": "0.1.0"
  }
}
```

#### シンプルJSON（デバイス向け）
```json
{
  "meta": {
    "schema": "motionkit",
    "version": "0.1.0"
  }
}
```

#### C++ API（生成ヘッダ＆実行）
```cpp
#define MOTIONKIT_SCHEMA "motionkit"
#define MOTIONKIT_VERSION "0.1.0"
```
